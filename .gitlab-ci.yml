# Using example from here: https://gitlab.com/pages/sphinx
# and from https://gitlab.nist.gov/gitlab/nexuslims/NexusMicroscopyLIMS/blob/6c8a53c8321423405901f8436c6acd86a8a36010/.gitlab-ci.yml for working with conda
pages:
  script:
  - /opt/conda/bin/conda --version
  - /opt/conda/bin/conda config --set always_yes yes
  - /opt/conda/bin/conda config --set auto_update_conda False
  - env_name="$(pwd)/pages_builder"
  - /opt/conda/bin/conda remove -p ${env_name} --all || true
  # retry building the requirements up to five times
  - for i in $(seq 1 5); do [ $i -gt 1 ] && echo "Sleeping for 15 seconds..."; sleep 15; /opt/conda/bin/conda create -p ${env_name} python=3.7 && s=0 && break || s=$?; done; (exit $s)
  - source /opt/conda/bin/activate ${env_name}
  - pip install -r requirements.txt
  - pwd
  - cd instructions
  - pwd
  - make html
  - cd ..
  - pwd
  - mv instructions/_build/html/ public/
  - ls -lah public
  artifacts:
    paths:
      - public
  only:
    - 2019-05_NIST_tutorial
